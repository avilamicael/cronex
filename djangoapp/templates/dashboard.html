{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border-radius: 10px;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .card-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    .stat-value {
        font-size: 28px;
        font-weight: 700;
        margin: 8px 0;
    }
    .stat-label {
        font-size: 14px;
        color: #6c757d;
        font-weight: 500;
    }
    .stat-count {
        font-size: 12px;
        color: #6c757d;
        margin-top: 4px;
    }
    .supplier-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 8px;
    }
    .supplier-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #4e73df 0%, #224abe 100%);
        border-radius: 10px;
        transition: width 0.5s ease;
    }
    .card-icon i {
        color: inherit !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
        </h1>
        <div class="text-muted">
            <i class="fas fa-calendar-alt mr-1"></i>
            {{ mes_atual|mes_portugues }}
        </div>
    </div>

    <!-- CARDS DE RESUMO -->
    <div class="row mb-4">
        <!-- Contas Pendentes -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card dashboard-card border-left-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label text-uppercase mb-1">
                                Contas Pendentes
                            </div>
                            <div class="stat-value text-warning">
                                {{ contas_pendentes.total|formatar_brl }}
                            </div>
                            <div class="stat-count">
                                {{ contas_pendentes.quantidade|default:0 }} conta{{ contas_pendentes.quantidade|default:0|pluralize }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="card-icon">
                                <i class="fas fa-dollar-sign fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contas Vencidas -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card dashboard-card border-left-danger">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label text-uppercase mb-1">
                                Contas Vencidas
                            </div>
                            <div class="stat-value text-danger">
                                {{ contas_vencidas.total|formatar_brl }}
                            </div>
                            <div class="stat-count">
                                {{ contas_vencidas.quantidade|default:0 }} conta{{ contas_vencidas.quantidade|default:0|pluralize }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="card-icon">
                                <i class="fas fa-dollar-sign fa-2x text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contas Pagas no Mês -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card dashboard-card border-left-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label text-uppercase mb-1">
                                Pagas este Mês
                            </div>
                            <div class="stat-value text-success">
                                {{ contas_pagas_mes.total|formatar_brl }}
                            </div>
                            <div class="stat-count">
                                {{ contas_pagas_mes.quantidade|default:0 }} conta{{ contas_pagas_mes.quantidade|default:0|pluralize }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="card-icon bg-light">
                                <i class="fas fa-dollar-sign fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Próximos 7 Dias -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card dashboard-card border-left-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="stat-label text-uppercase mb-1">
                                Próximos 7 Dias
                            </div>
                            <div class="stat-value text-info">
                                {{ contas_proximos_7_dias.total|formatar_brl }}
                            </div>
                            <div class="stat-count">
                                {{ contas_proximos_7_dias.quantidade|default:0 }} conta{{ contas_proximos_7_dias.quantidade|default:0|pluralize }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <div class="card-icon bg-light">
                                <i class="fas fa-dollar-sign fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICO DE PAGAMENTOS POR DIA - FULL WIDTH -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Pagamentos por Dia do Mês
                    </h6>
                    <div class="dropdown no-arrow">
                        <span class="badge badge-primary">{{ mes_atual|mes_portugues }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="paymentsChart" style="height: 400px;"></canvas>
                    </div>
                    <hr>
                    <!-- Legenda de cores -->
                    <div class="d-flex flex-wrap justify-content-center mt-3">
                        <div class="d-flex align-items-center mr-4 mb-2">
                            <div style="width: 16px; height: 16px; background: #22c55e; border-radius: 4px;" class="mr-2"></div>
                            <small class="text-muted">Até R$ 2.000</small>
                        </div>
                        <div class="d-flex align-items-center mr-4 mb-2">
                            <div style="width: 16px; height: 16px; background: #eab308; border-radius: 4px;" class="mr-2"></div>
                            <small class="text-muted">R$ 2.000 - R$ 5.000</small>
                        </div>
                        <div class="d-flex align-items-center mr-4 mb-2">
                            <div style="width: 16px; height: 16px; background: #f97316; border-radius: 4px;" class="mr-2"></div>
                            <small class="text-muted">R$ 5.000 - R$ 10.000</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <div style="width: 16px; height: 16px; background: #ef4444; border-radius: 4px;" class="mr-2"></div>
                            <small class="text-muted">Acima de R$ 10.000</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOP FORNECEDORES E RELATÓRIO - MESMA LINHA -->
    <div class="row">
        <!-- TOP FORNECEDORES -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-award mr-2"></i>
                        Top Fornecedores
                    </h6>
                    <small class="text-muted">Maiores valores a pagar</small>
                </div>
                <div class="card-body">
                    {% if top_fornecedores %}
                        {% for fornecedor in top_fornecedores %}
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="d-flex align-items-center">
                                        <span class="badge badge-primary mr-2">{{ forloop.counter }}</span>
                                        <span class="font-weight-bold" style="font-size: 14px;">
                                            {{ fornecedor.fornecedor__nome|default:"Não informado" }}
                                        </span>
                                    </div>
                                    <span class="font-weight-bold text-primary">
                                        {{ fornecedor.total|formatar_brl }}
                                    </span>
                                </div>
                                <div class="supplier-bar">
                                    <div class="supplier-bar-fill" style="width: {% widthratio fornecedor.total top_fornecedores.0.total 100 %}%"></div>
                                </div>
                                <small class="text-muted">{{ fornecedor.quantidade }} conta{{ fornecedor.quantidade|pluralize }}</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhum fornecedor encontrado</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Card de Relatório de Faturamento -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <div class="card shadow border-left-primary">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>
                        Relatório de Faturamento Mensal
                    </h6>
                </div>
                <div class="card-body">
                    {% if ultimo_relatorio and ultimo_relatorio.arquivo_zip %}
                        <div class="text-center py-3">
                            <i class="fas fa-file-archive fa-3x text-success mb-3"></i>
                            <h5 class="mb-3">Relatório Disponível</h5>
                            <p class="text-muted mb-1">
                                <strong>Período:</strong> {{ ultimo_relatorio.mes_ano_formatado }}
                            </p>
                            <p class="text-muted mb-4">
                                <small><i class="fas fa-clock mr-1"></i>Gerado em {{ ultimo_relatorio.data_geracao|date:"d/m/Y às H:i" }}</small>
                            </p>
                            <a href="{% url 'download_relatorio_faturamento' ultimo_relatorio.id %}"
                               class="btn btn-success btn-lg">
                                <i class="fas fa-download mr-2"></i>Baixar Relatório
                            </a>
                        </div>
                        <hr>
                        <div class="alert alert-info mb-0" role="alert">
                            <i class="fas fa-info-circle mr-2"></i>
                            <small>
                                <strong>Conteúdo:</strong> O arquivo ZIP contém uma pasta para cada filial com os dados das contas pagas no período.
                            </small>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Nenhum relatório disponível</h6>
                            <p class="text-muted mb-0">
                                <small>O relatório mensal é gerado automaticamente todo dia 1º de cada mês.</small>
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<!-- Carrega Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dados do gráfico vindos do Django
    const chartData = {{ chart_data|safe }};

    // Prepara os dados para o Chart.js
    const labels = chartData.map(d => 'Dia ' + d.dia);
    const valores = chartData.map(d => d.valor);
    const quantidades = chartData.map(d => d.quantidade);
    const fornecedores = chartData.map(d => d.fornecedores);

    // Função para determinar cor baseada no valor
    function getBarColor(value) {
        if (value > 10000) return '#ef4444'; // red
        if (value > 5000) return '#f97316';  // orange
        if (value > 2000) return '#eab308';  // yellow
        if (value > 0) return '#22c55e';     // green
        return '#e5e7eb';                    // gray (sem valor)
    }

    const backgroundColors = valores.map(v => getBarColor(v));

    // Configuração do gráfico
    const ctx = document.getElementById('paymentsChart');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor a Pagar',
                data: valores,
                backgroundColor: backgroundColors,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#1f2937',
                    bodyColor: '#4b5563',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return 'Dia ' + chartData[context[0].dataIndex].dia;
                        },
                        label: function(context) {
                            return '';  // Remove o label padrão
                        },
                        afterLabel: function(context) {
                            const index = context.dataIndex;
                            const valor = chartData[index].valor;
                            const qtd = chartData[index].quantidade;
                            const forn = chartData[index].fornecedores;

                            let lines = [];
                            lines.push('Valor Total: R$ ' + valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
                            lines.push('Quantidade: ' + qtd + (qtd === 1 ? ' conta' : ' contas'));

                            if (forn && forn.length > 0) {
                                lines.push('');
                                lines.push('Fornecedores:');
                                forn.forEach(f => {
                                    lines.push('• ' + f);
                                });
                            }

                            return lines;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    },
                    grid: {
                        color: '#f3f4f6'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
